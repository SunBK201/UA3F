# UA3F Desync TCP 分片乱序发射

UA3F Desync 是一种无服务器对抗 DPI 的方式，UA3F Desync 会针对 TCP 进行强制二分分片，同时进行丢弃首片转发尾片，从而达到分片乱序发射的目的，随后首片触发 TCP 重传，继续进行下一轮二分分片乱序发射。

UA3F Desync 可以通过 「Desync 字节」与 「Desync 数据包」参数进行控制分片乱序发射轮数，因此开启 TCP Desync 可能会造成 TCP 连接建立后早期的网络通信波动，但不会对后期长时通信造成影响。

## 为什么 TCP 分片乱序发射可以对抗深度包检测（DPI）？

DPI 设备通常会对经过的流量进行重组和特征匹配，其目标是在尽可能接近真实通信内容的层面上分析数据包，从而识别特定协议、特征字符串或者行为模式。

然而，在实际部署中，DPI 重组 TCP 流的能力受到性能与实现策略的限制。TCP 异常、分片乱序、重传、窗口变化等情况都可能显著增加 DPI 的处理复杂度与缓存压力。

UA3F Desync 通过制造"分片乱序"与"伪重传"现象，使 DPI 面临以下困难：

状态错乱
DPI 在重组 TCP 流时，必须跟踪每个连接的序列号与数据内容。如果发送端故意发送乱序分片，且这些分片与合法内容发生覆盖或重传冲突，DPI 在决定"哪段数据才是正确的"时容易出现分歧。客户端与服务器的 TCP 栈会遵循标准处理逻辑（例如按序列号覆盖数据），而 DPI 由于缺乏真实上下文，可能选择了错误的一段数据来重组，从而"脱同步"（Desync）。

缓存开销与性能限制
对于高速环境下的 DPI，缓存所有乱序段直至完整重组成本极高。一旦设备因超时丢弃某些段或采用简化策略（如只取首片），便可能漏检或误判。

协议歧义
DPI 设备往往会根据首包进行协议嗅探，通过制造传输层的不确定性，让 DPI 在早期识别阶段做出错误的协议判断并陷入错误的解析路径，从而实现对 DPI 检测的有效干扰。

# UA3F Desync TCP 混淆注入

开启 TCP 混淆注入后，UA3F 会在 TCP 完成握手后发送一个大小为 64B 的随机混淆数据包，该数据包用于干扰破环 DPI 设备内容重组状态机，同时为了避免该混淆数据包干扰 TCP 正常通信，混淆数据包的 TTL 数值会设置为很低（默认为 3），使该数据包在空中被丢弃，从而避免该混淆数据包目标主机接收。由于该特性需要依赖操控 TTL 数值，因此如果开启固定 TTL 功能，出站数据包 TTL 会有 2 种，一种为 64，一种为 3。
